# Transformer模式的金融预测数据源设计方案

## 项目概述

### 设计目标
基于Transformer架构，设计最优的市场深度数据源结构，用于预测纯供需驱动连续市场的价格变动概率。

### 核心理念
- **最大化Transformer注意力机制效果**：充分利用自注意力发现复杂时间模式
- **适配连续市场特点**：无开盘收盘，纯供需驱动，24小时交易
- **平衡信息与效率**：在信息丰富度与计算复杂度间找到最佳平衡点

---

## 数据源架构设计

### 1. 时间窗口设计

#### 输入窗口：30分钟
**技术依据**：
- **序列长度30**：处于Transformer注意力机制的最佳工作区间(20-60)
- **信息完整性**：足够捕捉供需力量的完整演化周期
- **计算效率**：避免序列过长导致注意力计算复杂度爆炸
- **模式识别**：为注意力机制提供足够的上下文发现关键转折点

#### 预测窗口：多时间尺度
```
预测目标设计：
├── 短期预测：未来5分钟
│   ├── 目的：高精度即时预测
│   └── 应用：快速交易决策参考
├── 中期预测：未来10分钟  
│   ├── 目的：趋势方向判断
│   └── 应用：策略调整依据
└── 长期预测：未来15分钟
    ├── 目的：宏观方向把握
    └── 应用：风险管理参考
```

**多时间尺度优势**：
- 一个模型同时学习不同时间依赖关系
- 增加训练样本的信息密度和利用效率
- 为不同应用场景提供精度匹配的预测

#### 数据频率：1分钟级别
**频率选择依据**：
- **信噪比平衡**：比秒级数据噪声更少，比5分钟级数据信息更丰富
- **实时性保证**：1分钟更新满足实际应用需求
- **Transformer适配**：中等时间颗粒度适合注意力机制处理

### 2. 特征工程架构

#### 一级特征：原始深度数据（8维）
```
基础订单簿特征：
├── 买方深度
│   ├── 买一价格 (bid1_price)
│   ├── 买一数量 (bid1_volume)
│   ├── 买二价格 (bid2_price)
│   └── 买二数量 (bid2_volume)
└── 卖方深度
    ├── 卖一价格 (ask1_price)
    ├── 卖一数量 (ask1_volume)
    ├── 卖二价格 (ask2_price)
    └── 卖二数量 (ask2_volume)
```

#### 二级特征：即时衍生特征（6维）
```
微观结构特征：
├── 买卖价差 = ask1_price - bid1_price
├── 中间价格 = (bid1_price + ask1_price) / 2
├── 深度比例 = bid1_volume / (bid1_volume + ask1_volume)
├── 总流动性 = bid1_volume + ask1_volume
├── 二档价差 = ask2_price - bid2_price
└── 深度梯度 = (bid2_volume - bid1_volume) / bid1_volume
```

**设计原理**：
- **价差信息**：反映买卖双方的博弈强度
- **流动性指标**：衡量市场的交易活跃度
- **深度结构**：揭示订单簿的支撑阻力分布

#### 三级特征：时序衍生特征（6维）
```
动态演化特征：
├── 价格动量 = 当前中间价 - 5分钟前中间价
├── 量能变化率 = 当前总深度 / 5分钟前总深度
├── 压力迁移 = 当前深度比例 - 5分钟前深度比例
├── 短期波动率 = 最近3分钟价格标准差
├── 成交倾向 = 主动买量 - 主动卖量 (如有tick数据)
└── 深度稳定性 = 1 / 最近5分钟深度变异系数
```

**时序特征价值**：
- **动量信息**：捕捉价格和量能的变化趋势
- **稳定性指标**：评估市场状态的持续性
- **压力转移**：识别买卖力量的动态平衡变化

#### 特征维度总结
**总计20维特征**：8(原始) + 6(即时衍生) + 6(时序衍生)
- **信息密度**：每分钟20个特征值，为多头注意力提供充足信息
- **层次结构**：从原始数据到高阶抽象，满足不同注意力头的需求

### 3. 数据张量结构

#### 输入张量设计
```
张量形状: [batch_size, sequence_length, feature_dim]
具体尺寸: [N, 30, 20]

维度解释:
├── batch_size (N): 批次大小，根据显存调整
├── sequence_length (30): 时间序列长度，30分钟
└── feature_dim (20): 特征向量维度
```

#### 输出标签设计
```
多任务预测结构:
{
    "pred_5min": {
        "up_prob": float,      # 上涨概率
        "down_prob": float,    # 下跌概率  
        "flat_prob": float     # 持平概率
    },
    "pred_10min": {
        "up_prob": float,
        "down_prob": float,
        "flat_prob": float
    },
    "pred_15min": {
        "up_prob": float,
        "down_prob": float,
        "flat_prob": float
    }
}
```

**标签生成规则**：
```
价格变化阈值（连续市场典型）:
├── 上涨: price_change >= +0.0001 (1 pip)
├── 下跌: price_change <= -0.0001 (1 pip)
└── 持平: -0.0001 < price_change < +0.0001
```

---

## 数据采样与预处理

### 1. 滑动窗口采样策略

#### 采样机制
```
滑动窗口采样：
时间窗口[0-30分钟]   → 预测[30-35, 30-40, 30-45分钟]
时间窗口[1-31分钟]   → 预测[31-36, 31-41, 31-46分钟]  
时间窗口[2-32分钟]   → 预测[32-37, 32-42, 32-47分钟]
...

采样频率: 每1分钟滑动一次
样本生成: 30天数据可生成约43,000个训练样本
```

#### 连续市场的均匀采样
```
采样权重策略：
├── 所有时间段: 统一权重 1.0
├── 无时段歧视: 不区分"活跃"vs"清淡"时段
├── 质量导向: 完全基于数据质量筛选样本
└── 连续性优势: 充分利用24小时连续交易的稳定性
```

### 2. 数据质量控制

#### 样本筛选标准
```
质量检查清单：
├── 完整性检查
│   ├── 30分钟内无数据缺失
│   └── 所有特征值均有效
├── 流动性检查
│   ├── 最小总深度 > 设定阈值
│   └── 买卖双方均有足够深度
├── 连续性检查
│   ├── 价格跳跃 < 3σ 异常值
│   └── 量能变化在合理范围内
└── 有效性检查
    ├── 预测期内确实发生价格变化
    └── 避免完全静止的市场时段
```

#### 异常值处理策略
```
异常检测与处理：
├── 价格异常
│   ├── 检测: 价格跳跃 > 3σ
│   └── 处理: 标记异常，考虑插值或剔除
├── 量能异常  
│   ├── 检测: 数量 > 5倍历史均值
│   └── 处理: Cap处理或样本剔除
└── 系统异常
    ├── 检测: 数据源故障、网络延迟
    └── 处理: 整段时间剔除
```

### 3. 特征标准化

#### 分类标准化策略
```
特征标准化方案：
├── 价格类特征 (bid1_price, ask1_price, etc.)
│   └── Z-score标准化: (x - μ) / σ
├── 数量类特征 (bid1_volume, ask1_volume, etc.)
│   └── Min-Max标准化: (x - min) / (max - min)
├── 比例类特征 (depth_ratio, etc.)
│   └── 无需标准化: 本身在[0,1]范围
├── 变化率特征 (price_momentum, etc.)
│   └── Robust标准化: (x - median) / IQR
└── 波动率特征 (volatility, etc.)
    └── Log标准化: log(1 + x)
```

#### 标准化参数更新
```
动态标准化：
├── 滑动窗口: 使用最近1000个样本的统计量
├── 更新频率: 每100个新样本更新一次参数
└── 异常值鲁棒: 使用分位数而非均值方差
```

---

## Transformer架构适配

### 1. 注意力机制优化

#### 多头注意力分工设计
```
8头注意力分工策略：
├── Head 1-2: 短期模式注意力
│   ├── 关注范围: 最近5-10分钟
│   └── 捕捉目标: 即时供需变化
├── Head 3-4: 中期趋势注意力  
│   ├── 关注范围: 最近10-20分钟
│   └── 捕捉目标: 趋势形成过程
├── Head 5-6: 长期背景注意力
│   ├── 关注范围: 整个30分钟窗口
│   └── 捕捉目标: 宏观供需格局
└── Head 7-8: 跨特征关系注意力
    ├── 关注维度: 价格vs量能，买vs卖
    └── 捕捉目标: 特征间的复杂交互
```

#### 注意力模式选择
```
全注意力机制 (推荐)：
├── 每个时间点能观察所有其他时间点
├── 适合发现复杂的供需因果关系
├── 支持"未来验证过去"的推理模式
└── 充分利用Transformer的并行计算优势
```

### 2. 位置编码策略

#### 多层次时间编码
```
时间编码方案：
├── 绝对位置编码
│   ├── 序列位置: 1, 2, 3, ..., 30
│   └── 作用: 保持时间顺序信息
├── 相对位置编码
│   ├── 相对距离: -30, -29, ..., -1  
│   └── 作用: 强化"距离预测点的远近"
└── 周期性编码 (可选)
    ├── 小时内位置: 分钟 % 60
    └── 作用: 捕捉小时级的周期性模式
```

### 3. 多任务学习架构

#### 共享编码器设计
```
Transformer编码器 (共享):
├── 输入: [batch, 30, 20] 特征张量
├── 编码: 4层 Transformer Encoder
├── 输出: [batch, 30, hidden_dim] 编码表示
└── 池化: Global Average Pooling → [batch, hidden_dim]
```

#### 多任务预测头
```
预测头设计：
├── 5分钟预测头
│   ├── 结构: Linear(hidden_dim, 64) → ReLU → Linear(64, 3)
│   └── 输出: 3维概率分布 (上涨/下跌/持平)
├── 10分钟预测头 
│   ├── 结构: Linear(hidden_dim, 64) → ReLU → Linear(64, 3)
│   └── 输出: 3维概率分布
└── 15分钟预测头
    ├── 结构: Linear(hidden_dim, 64) → ReLU → Linear(64, 3)  
    └── 输出: 3维概率分布
```

---

## 预期性能与优势

### 1. Transformer优势的充分发挥

#### 注意力机制效果最大化
- **30分钟序列**：为注意力提供充足的上下文信息
- **20维特征**：支持多头注意力在不同维度并行工作
- **全局视野**：每个时间点都能"看到"完整的供需演化过程

#### 复杂模式识别能力
- **非线性时间依赖**：发现"第5分钟买盘→第25分钟卖压"等复杂关系
- **特征交互建模**：自动学习价格、量能、时间的高阶交互
- **关键节点识别**：通过注意力权重可视化关键决策时刻

### 2. 连续市场适配优势

#### 纯供需信号学习
- **无噪声干扰**：避免开盘跳空、集合竞价等非连续因素
- **稳定环境**：模型专注学习订单簿微观结构规律
- **一致性保证**：24小时连续交易提供稳定的学习环境

#### 数据利用效率
- **高密度采样**：每分钟产生新样本，30天→43,000样本
- **质量保证**：基于数据质量而非时间偏好进行筛选
- **稳定性增强**：连续市场减少了模型需要学习的环境变量

### 3. 实用性优势

#### 开发与部署
- **数据需求合理**：30天历史数据基本满足训练需求
- **计算成本可控**：30×20的张量尺寸适合常见GPU显存
- **实时性良好**：1分钟更新频率满足实际应用需求

#### 扩展性与维护
- **特征可扩展**：框架支持新增特征维度
- **多任务一体**：单一模型提供多时间尺度预测
- **可解释性**：注意力权重提供模型决策的可视化解释

---

## 实施建议

### 1. 开发阶段规划

#### 第一阶段：数据管道搭建
- **数据收集**：建立30天滚动数据采集系统
- **特征工程**：实现20维特征计算管道
- **质量控制**：部署数据质量监控与异常检测

#### 第二阶段：模型原型开发
- **基础架构**：实现Transformer编码器
- **多任务头**：构建三个时间尺度的预测分支
- **训练流程**：设计端到端的训练与验证流程

#### 第三阶段：性能优化
- **超参数调优**：优化学习率、层数、注意力头数等
- **注意力分析**：可视化注意力模式，调整架构设计
- **增量学习**：实现模型的在线更新机制

### 2. 评估指标体系

#### 预测准确性指标
- **分类准确率**：三分类的整体准确率 (目标>50%)
- **各类别F1**：上涨、下跌、持平的F1分数
- **概率校准**：预测概率与实际频率的匹配度

#### 注意力质量指标
- **注意力熵**：评估注意力分布的集中度
- **时间偏好分析**：统计模型最关注的时间段
- **特征重要性**：通过注意力权重分析特征贡献

#### 实用性指标
- **预测稳定性**：连续预测的一致性
- **延迟敏感性**：输入延迟对预测精度的影响
- **概念漂移适应**：模型对市场环境变化的适应能力

---

**文档版本**: v1.0  
**创建时间**: 2024年12月  
**状态**: 设计方案阶段 